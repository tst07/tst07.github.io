
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="/theme/pygments/emacs.min.css">

    <script src="/theme/tipuesearch/jquery.min.js"></script>
    <script src="/theme/tipuesearch/tipuesearch.min.js"></script>
    <script src="/theme/tipuesearch/tipuesearch.min.js"></script>
    <script src="/theme/tipuesearch/tipuesearch_set.min.js"></script>
    <script src="/tipuesearch_content.js"></script>
    <link rel="stylesheet" href="/theme/tipuesearch/tipuesearch.min.css" />

  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/solid.css">


    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Prakhar Mishra Atom">

    <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Prakhar Mishra RSS">


<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-191819273-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Prakhar Mishra" />
<meta name="description" content="How to fix host header injection in your application which uses flask and nginx" />
<meta name="keywords" content="security, flask, django, nginx">


<meta property="og:site_name" content="Prakhar Mishra"/>
<meta property="og:title" content="Fixing Host Header Injection in Flask/Nginx setup"/>
<meta property="og:description" content="How to fix host header injection in your application which uses flask and nginx"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/articles/host-header-injection-1.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-03-14 00:00:00+05:30"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/prakhar-mishra.html">
<meta property="article:section" content="programming"/>
<meta property="article:tag" content="security"/>
<meta property="article:tag" content="flask"/>
<meta property="article:tag" content="django"/>
<meta property="article:tag" content="nginx"/>
<meta property="og:image" content="/images/prakhar.jpeg">

  <title>Prakhar Mishra &ndash; Fixing Host Header Injection in Flask/Nginx setup</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-8793729856692815",
      enable_page_level_ads: true
    });
  </script>
</head>
<body >
  <aside>
    <div>
      <a href="">
        <img src="/images/prakhar.jpeg" alt="Prakhar Mishra" title="Prakhar Mishra">
      </a>

      <h1>
        <a href="">Prakhar Mishra</a>
      </h1>

<p>Software Engineer</p>
        <form class="navbar-search" action="/search.html" role="search">
          <input type="text" name="q" id="tipue_search_input" placeholder="Search...">
        </form>

      <nav>
        <ul class="list">



            <li>
              <a target="_self" href="/" >Home</a>
            </li>
            <li>
              <a target="_self" href="/categories.html" >Categories</a>
            </li>
            <li>
              <a target="_self" href="/tags.html" >Tags</a>
            </li>
            <li>
              <a target="_self" href="/pages/About.html" >About</a>
            </li>
            <li>
              <a target="_self" href="/pages/Contact.html" >Contact</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/prakhar1467-11" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
          <li>
            <a  class="sc-github" href="https://github.com/tst07" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-youtube" href="https://www.youtube.com/channel/UC4J1E1YPJy8PH0F1rnOaYfQ" target="_blank">
              <i class="fab fa-youtube"></i>
            </a>
          </li>
          <li>
            <a  class="sc-instagram" href="https://www.instagram.com/prakhar1467" target="_blank">
              <i class="fab fa-instagram"></i>
            </a>
          </li>
      </ul>
    </div>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle ads-aside"
           data-ad-client="ca-pub-8793729856692815"
           data-ad-slot="1234561"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
  </aside>
  <main>

    <nav>
      <a href="">Home</a>

      <a href="/category/programming.html">Code</a>
      <a href="/category/life.html">Life</a>
      <a href="/category/music.html">Music</a>
      <a href="/archives.html">Archives</a>

      <a href="/feeds/all.atom.xml">Atom</a>

      <a href="/feeds/all.rss.xml">RSS</a>
    </nav>

<article class="single">
  <header>
      
    <h1 id="host-header-injection-1">Fixing Host Header Injection in Flask/Nginx setup</h1>
    <p>
      Posted on 3æœˆ 14 2021 in <a href="/category/programming.html">programming</a>

    </p>
  </header>


  <div>
    <p>Host header injection is a very common vulnerability found in today's websites. An adversary could use this attack to poison the host header and further carry out malicious activities on the victim.
In Http request-response model, host header is one of the header found in request made by client. Sometimes web servers use this header information to redirect the request to appropriate application
running on some port in the server, sometimes web application use this header to create absolute urls added in thier rounting file (such as urls.py file in Django). The issue is, since the host header
is sent by client, we can never trust this data to make server side decisions. </p>
<p>Two of the most severe attacks an adversary can do are:</p>
<ol>
<li>Password reset poisoning.</li>
<li>Web cache poisoning.</li>
</ol>
<p>Other kind of security breaches can also be done on top of this vulnerablity. For an example, an attacker can get the secret token to reset a user's password by passing malicious header. The web 
application will then create an absolute URL with malicious header which has the secret token and send the password reset link to the real user's mail. 
If user happens to click on that reset link which is recieved in his/her mail out of nowhere, User will pass that secret token to an attacker controlled host. </p>
<p>To mitigate this, there are two kinds of check which we can apply:</p>
<ul>
<li>Whitelist hosts in our web application.</li>
<li>Whitelist hosts in our web server conf. (Our nginx server).</li>
</ul>
<p>Some frameworks such as Django provide configuration variable in settings file while in other framworks we have to check the host header before we process any request. In Django, the setting variable
is <code>ALLOWED_HOSTS = []</code>, where we have to provide host names as a list. But more than often, people put an astrix '*' in that list and carry on this to the production. I advice you to put your IP address
or domain name or both in that list and then go for production. This will fix the issue at application level and you will be free of this vulnerability.</p>
<p>In Flask, We have a decorator named <code>@app.before_request</code> which allows us to manipulate and validate any requests coming to the server. </p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="k">def</span> <span class="nf">check_for_maintenance</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;10.x.y.z&#39;</span><span class="p">,</span> <span class="s1">&#39;www.mywebsite.com&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;_site/403.html&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">IS_MAINTENANCE_MODE</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">!=</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;maintenance&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;maintenance&#39;</span><span class="p">))</span>
</code></pre></div>

<p>This is how we handle and fix the issue using flask/django. Now let's discuss how we can block maliciouos headers using our nginx:</p>
<ol>
<li>Open your nginx.conf file (in my case path is <code>/usr/local/conf/nginx.conf</code>)</li>
<li>Add the below code in your server block:</li>
</ol>
<div class="highlight"><pre><span></span><code>server <span class="o">{</span>
    listen <span class="m">443</span> ssl<span class="p">;</span>
    ...
    ...

    <span class="c1"># Deny bad headers</span>
    <span class="k">if</span> <span class="o">(</span><span class="nv">$host</span> !~* ^<span class="o">(</span>www.mywebsite.com<span class="o">)</span>$ <span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="m">444</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>Voila, you are good to go. Now nginx is not gonna accept any header other than your mentioned whitelisted one.
I hope you found this blog helpful, write in the comments if you have any doubts or if you get stuck somewhere. Thanks for reading this, and I will see you in the next one!</p>
<hr>
<p><strong> DISCLAIMER: </strong> The author doesn't intend to be expert on the problems. While these notes will solve your problem at hand, it is always advised to dig deep to the problem if one is interested and also share
your further learnings in the comments below as well.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/security.html">security</a>
      <a href="/tag/flask.html">flask</a>
      <a href="/tag/django.html">django</a>
      <a href="/tag/nginx.html">nginx</a>
    </p>
  </div>




    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-8793729856692815"
         data-ad-slot="1234566"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

</article>

    <footer>
<p>&copy; 2021 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Prakhar Mishra ",
  "url" : "",
  "image": "/images/prakhar.jpeg",
  "description": "Foo Bar's Thoughts and Writings"
}
</script>

    <script>
      $(document).ready(function() {
        $('#tipue_search_input').tipuesearch();
      });
    </script>

</body>
</html>